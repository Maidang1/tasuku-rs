name: Version Bump

on:
  push:
    branches:
      - main
    paths:
      - '.changeset/**'
      - '!.changeset/README.md'
      - '!.changeset/config.json'
      - '!.changeset/.gitkeep'

jobs:
  version:
    name: Create version bump PR
    runs-on: ubuntu-latest

    # Prevent this workflow from running on version bump commits
    if: "!startsWith(github.event.head_commit.message, 'chore: release')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for changesets
        id: check_changesets
        run: |
          CHANGESETS=$(find .changeset -name "*.md" -not -name "README.md" | wc -l)
          echo "count=$CHANGESETS" >> $GITHUB_OUTPUT

          if [ "$CHANGESETS" -eq 0 ]; then
            echo "No changesets found"
            exit 0
          fi

          echo "Found $CHANGESETS changeset(s)"

      - name: Process changesets
        if: steps.check_changesets.outputs.count > 0
        run: |
          chmod +x scripts/version-bump.sh
          ./scripts/version-bump.sh

      - name: Get new version
        if: steps.check_changesets.outputs.count > 0
        id: get_version
        run: |
          NEW_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Create Pull Request
        if: steps.check_changesets.outputs.count > 0
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: release v${{ steps.get_version.outputs.version }}'
          title: 'chore: release v${{ steps.get_version.outputs.version }}'
          body: |
            This PR was automatically generated by the version bump workflow.

            ## Changes

            - Updated version to ${{ steps.get_version.outputs.version }}
            - Updated CHANGELOG.md with changeset entries
            - Removed processed changeset files

            ## Next Steps

            After merging this PR:
            1. A git tag `v${{ steps.get_version.outputs.version }}` will be created
            2. The publish workflow will automatically publish to crates.io
          branch: release/v${{ steps.get_version.outputs.version }}
          delete-branch: true
          labels: |
            release
            automated
